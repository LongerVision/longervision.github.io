<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Build U-Boot and Linux Kernel for Beaglebone and Beaglebone Black | Longer Vision Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Happy new year everybody. How time flies. It is already 2018. Longer Vision has been struggling on this tough road towards a successful enterprise. Algorithms ONLY are NOT enough for nowadays business">
<meta name="keywords" content="Beaglebone, Beaglebone Black, Linaro GCC, U-Boot, Linux Kernel, BSP">
<meta property="og:type" content="article">
<meta property="og:title" content="Build U-Boot and Linux Kernel for Beaglebone and Beaglebone Black">
<meta property="og:url" content="https://longervision.github.io/2018/01/10/beaglebone-black-uboot-kernel/index.html">
<meta property="og:site_name" content="Longer Vision Blog">
<meta property="og:description" content="Happy new year everybody. How time flies. It is already 2018. Longer Vision has been struggling on this tough road towards a successful enterprise. Algorithms ONLY are NOT enough for nowadays business">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://longervision.github.io/2018/01/10/beaglebone-black-uboot-kernel/BBB.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LongerVision/BSP/master/ti/omap/beaglebone/black/images/kernelconfiguration.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LongerVision/BSP/master/ti/omap/beaglebone/black/images/afterkernelconfiguration.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LongerVision/BSP/master/ti/omap/beaglebone/black/images/kernelbuilt.jpg">
<meta property="og:updated_time" content="2018-02-25T20:46:50.770Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Build U-Boot and Linux Kernel for Beaglebone and Beaglebone Black">
<meta name="twitter:description" content="Happy new year everybody. How time flies. It is already 2018. Longer Vision has been struggling on this tough road towards a successful enterprise. Algorithms ONLY are NOT enough for nowadays business">
<meta name="twitter:image" content="https://longervision.github.io/2018/01/10/beaglebone-black-uboot-kernel/BBB.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Longer Vision Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Longer Vision Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://longervision.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-beaglebone-black-uboot-kernel" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/10/beaglebone-black-uboot-kernel/" class="article-date">
  <time datetime="2018-01-11T06:46:13.000Z" itemprop="datePublished">2018-01-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Build U-Boot and Linux Kernel for Beaglebone and Beaglebone Black
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Happy new year everybody. How time flies. It is already 2018. <a href="http://www.longervision.com" target="_blank" rel="noopener">Longer Vision</a> has been struggling on this tough road towards a successful enterprise. Algorithms <strong>ONLY</strong> are <strong>NOT</strong> enough for nowadays business. <a href="https://en.wikipedia.org/wiki/Board_support_package" target="_blank" rel="noopener">BSP (board support package)</a> and <a href="https://en.wikipedia.org/wiki/Integrated_circuit_design" target="_blank" rel="noopener">IC design</a> are a must for a successful business nowadays. Thus, ever since 2018, <a href="http://www.longervision.com" target="_blank" rel="noopener">Longer Vision</a> is going to balance <strong>both</strong> hardware <strong>and</strong> software, particularly, <a href="http://www.arm.com/" target="_blank" rel="noopener">ARM</a> based open source embedded development board and computer vision algorithms.</p>
<p>In this blog, we are going to talk about how to build and flash <a href="http://www.denx.de/wiki/U-Boot/WebHome" target="_blank" rel="noopener">U-Boot</a> and <a href="https://www.kernel.org/" target="_blank" rel="noopener">Linux Kernel</a> onto a <a href="https://beagleboard.org/bone-original" target="_blank" rel="noopener">Beaglebone</a> and <a href="https://beagleboard.org/black" target="_blank" rel="noopener">Beaglebone Black</a>, which adopts <a href="http://www.ti.com/processors/sitara/arm-cortex-a8/am335x/overview.html" target="_blank" rel="noopener">TI AM335x</a> as its CPU. The board looks like (cited from <a href="https://beagleboard.org/black" target="_blank" rel="noopener">Beaglebone Black</a> ):</p>
<p><img src="./BBB.jpg" alt="Beaglebone Black"></p>
<h1 id="PART-A-Cross-Compile-U-Boot-and-Linux-Kernel"><a href="#PART-A-Cross-Compile-U-Boot-and-Linux-Kernel" class="headerlink" title="PART A: Cross Compile U-Boot and Linux Kernel"></a>PART A: Cross Compile U-Boot and Linux Kernel</h1><h2 id="1-Linaro-GCC"><a href="#1-Linaro-GCC" class="headerlink" title="1. Linaro GCC"></a>1. Linaro GCC</h2><p><a href="https://www.linaro.org/" target="_blank" rel="noopener">Linaro</a> is a popular platform providing high-quality code for both <a href="https://www.kernel.org/" target="_blank" rel="noopener">Linux kernel</a> and <a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm" target="_blank" rel="noopener">GCC tool chain</a>. Linaroâ€™s GCC toolchain of varoius versions can be directly found <a href="https://releases.linaro.org/components/toolchain/binaries/" target="_blank" rel="noopener">here</a>. </p>
<p>Here, we download GCC latest-6 binary under <a href="https://releases.linaro.org/components/toolchain/binaries/latest-6/arm-linux-gnueabihf/" target="_blank" rel="noopener">arm-linux-gnueabihf</a>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget -c </span><br><span class="line">https://releases.linaro.org/components/toolchain/binaries/latest-6/arm-linux-gnueabihf/gcc-linaro-6.4.1-2017.11-x86_64_arm-linux-gnueabihf.tar.xz</span><br><span class="line">$ tar xf gcc-linaro-6.4.1-2017.11-x86_64_arm-linux-gnueabihf.tar.xz</span><br><span class="line">$ <span class="built_in">export</span> CC=`<span class="built_in">pwd</span>`/gcc-linaro-6.4.1-2017.11-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-</span><br></pre></td></tr></table></figure>
<p>Test the cross compiler:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$&#123;CC&#125;</span>gcc --version</span><br><span class="line">arm-linux-gnueabihf-gcc (Linaro GCC 6.4-2017.11) 6.4.1 20171012</span><br><span class="line">Copyright (C) 2017 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the <span class="built_in">source</span> <span class="keyword">for</span> copying conditions.  There is NO</span><br><span class="line">warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure></p>
<h2 id="2-U-Boot"><a href="#2-U-Boot" class="headerlink" title="2. U-Boot"></a>2. U-Boot</h2><p><a href="http://www.denx.de/wiki/U-Boot" target="_blank" rel="noopener">U-Boot</a> is a universal boot loader. For <a href="https://beagleboard.org/bone-original" target="_blank" rel="noopener">Beaglebone</a> and <a href="https://beagleboard.org/black" target="_blank" rel="noopener">Beaglebone Black</a>, there are two patches which has been maintained by <a href="http://eewiki.net/display/linuxonarm" target="_blank" rel="noopener">eewiki Linux on ARM</a> on <a href="https://github.com/eewiki/u-boot-patches" target="_blank" rel="noopener">github</a>.<br>We first download U-Boot and check out the latest release as follows:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/u-boot/u-boot</span><br><span class="line">$ <span class="built_in">cd</span> u-boot/</span><br><span class="line">$ git checkout v2018.01</span><br></pre></td></tr></table></figure></p>
<p>Then check out the latest <a href="https://github.com/eewiki/u-boot-patches" target="_blank" rel="noopener">u-boot-patches</a> and patch two files under the latest release <a href="https://github.com/eewiki/u-boot-patches/tree/master/v2018.01" target="_blank" rel="noopener">v2018.01</a>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/eewiki/u-boot-patches.git</span><br><span class="line">$ <span class="built_in">cd</span> ./u-boot-patches/v2018.01</span><br><span class="line">$ cp 0001-am335x_evm-uEnv.txt-bootz-n-fixes.patch ../../u-boot/</span><br><span class="line">$ cp 0002-U-Boot-BeagleBone-Cape-Manager.patch ../../u-boot/</span><br><span class="line">$ <span class="built_in">cd</span> ../../u-boot</span><br><span class="line">$ patch -p1 &lt; 0001-am335x_evm-uEnv.txt-bootz-n-fixes.patch</span><br><span class="line">$ patch -p1 &lt; 0002-U-Boot-BeagleBone-Cape-Manager.patch</span><br></pre></td></tr></table></figure></p>
<p>Finally, we configure and build U-Boot for <a href="https://beagleboard.org/bone-original" target="_blank" rel="noopener">Beaglebone</a> and <a href="https://beagleboard.org/black" target="_blank" rel="noopener">Beaglebone Black</a> as follows:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make ARCH=arm CROSS_COMPILE=<span class="variable">$&#123;CC&#125;</span> distclean</span><br><span class="line">$ make ARCH=arm CROSS_COMPILE=<span class="variable">$&#123;CC&#125;</span> am335x_evm_defconfig</span><br><span class="line">$ make ARCH=arm CROSS_COMPILE=<span class="variable">$&#123;CC&#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="3-Linux-Kernel"><a href="#3-Linux-Kernel" class="headerlink" title="3. Linux Kernel"></a>3. Linux Kernel</h2><p>Due to Robert Nelsonâ€™s summary at <a href="http://eewiki.net/display/linuxonarm/BeagleBone+Black" target="_blank" rel="noopener">eewiki</a>, there are two ways to build <a href="https://beagleboard.org/bone-original" target="_blank" rel="noopener">Beaglebone</a> and <a href="https://beagleboard.org/black" target="_blank" rel="noopener">Beaglebone Black</a>:</p>
<ul>
<li><a href="https://github.com/RobertCNelson/bb-kernel" target="_blank" rel="noopener">Mainline</a></li>
<li><a href="https://github.com/RobertCNelson/ti-linux-kernel-dev" target="_blank" rel="noopener">TI BSP</a></li>
</ul>
<p>Their differences are:</p>
<ul>
<li>bb-kernel: based on <a href="https://github.com/RobertCNelson/bb-kernel" target="_blank" rel="noopener">mainline</a>, no-smp, optimized for AM335x devices.</li>
<li>ti-linux-kernel-dev: based on <a href="https://github.com/RobertCNelson/ti-linux-kernel-dev" target="_blank" rel="noopener">TIâ€™s git tree</a>, smp, optimized for AM335x/AM43xx/AM57x devices.</li>
</ul>
<p>Here, we are going to use <a href="https://github.com/RobertCNelson/bb-kernel" target="_blank" rel="noopener">Mainline</a> to build our own Linux Kernel. We FIRST check out Robert Nelsonâ€™s <a href="https://github.com/RobertCNelson/bb-kernel" target="_blank" rel="noopener">bb-kernel</a>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/RobertCNelson/bb-kernel</span><br><span class="line">$ <span class="built_in">cd</span> bb-kernel/</span><br><span class="line">$ git checkout origin/am33x-v4.14 -b am33x-v4.14</span><br></pre></td></tr></table></figure>
<p>We then check out <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git" target="_blank" rel="noopener">Linus Torvaldsâ€™ stable Linux Kernel</a>, which can be also tracked on <a href="https://github.com/torvalds/linux" target="_blank" rel="noopener">github Torvalds Linux</a>. This will take you quite a while.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git</span><br></pre></td></tr></table></figure></p>
<p>Now, itâ€™s the time to modify some of the configurations in .sh files under the checked out branch <strong>am33x-v4.14</strong>. </p>
<h3 id="1-version-sh"><a href="#1-version-sh" class="headerlink" title="1) version.sh"></a>1) version.sh</h3><p>Here, Iâ€™m using <strong>gcc_linaro_gnueabihf_6</strong> instead of <strong>gcc_linaro_gnueabihf_7</strong>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">toolchain=&quot;gcc_linaro_gnueabihf_6&quot;</span><br><span class="line">#toolchain=&quot;gcc_linaro_gnueabihf_7&quot;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-system-sh"><a href="#2-system-sh" class="headerlink" title="2) system.sh"></a>2) system.sh</h3><p>A file named <strong>system.sh.sample</strong> has been provided for us to configure accordingly. We FIRST do a copy.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp system.sh.sample system.sh</span><br></pre></td></tr></table></figure></p>
<p>Then, we manually re-specifying two MACROs <strong>CC</strong> and <strong>LINUX_GIT</strong>, respectively to two directories containing the above downloaded Linaro GCC compiler and the current Torvaldsâ€™ Linux Kernel. We also specify <strong>MMC</strong> for TF/SD Card as follows:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CC=.../gcc-linaro-6.4.1-2017.11-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-</span><br><span class="line">LINUX_GIT=.../linux-stable</span><br><span class="line">MMC=/dev/mmcblk0</span><br></pre></td></tr></table></figure></p>
<p>After the above configurations, we start building the Linux Kernel using the following command line. This will probably take you one hour.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./build_kernel.sh</span><br></pre></td></tr></table></figure></p>
<p>When you see this <strong>Kernel Configuration</strong> page,<br><img src="https://raw.githubusercontent.com/LongerVision/BSP/master/ti/omap/beaglebone/black/images/kernelconfiguration.jpg" alt="Kernel Configuration"><br><strong>Exit</strong> right away without any modification. And you will see:<br><img src="https://raw.githubusercontent.com/LongerVision/BSP/master/ti/omap/beaglebone/black/images/afterkernelconfiguration.jpg" alt="After Kernel Configuration"><br>After a while, you will see <strong>Linux Kernel</strong> has been successfully built:<br><img src="https://raw.githubusercontent.com/LongerVision/BSP/master/ti/omap/beaglebone/black/images/kernelbuilt.jpg" alt="The Built Kernel"></p>
<h2 id="4-Root-File-System"><a href="#4-Root-File-System" class="headerlink" title="4. Root File System"></a>4. Root File System</h2><p>We then install the latest Debian (for now, Debian 9.3) according to Robert Nelsonâ€™s minimal operating system. Three commands are to be executed in a row for downloading, verifying, and extraction.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget -c https://rcn-ee.com/rootfs/eewiki/minfs/debian-9.3-minimal-armhf-2017-12-09.tar.xz</span><br><span class="line">$ sha256sum debian-9.3-minimal-armhf-2017-12-09.tar.xz</span><br><span class="line">5120fcfb8ff8af013737fae52dc0a7ecc2f52563a9aa8f5aa288aff0f3943d61  debian-9.3-minimal-armhf-2017-12-09.tar.xz</span><br><span class="line">$ tar xf debian-9.3-minimal-armhf-2017-12-09.tar.xz</span><br></pre></td></tr></table></figure></p>
<p>Until now, most components for booting have been downloaded and built. It is the time for us to flash our own OS onto a SD card.</p>
<h1 id="PART-B-Install-the-Linux-OS-onto-SD-Card"><a href="#PART-B-Install-the-Linux-OS-onto-SD-Card" class="headerlink" title="PART B: Install the Linux OS onto SD Card"></a>PART B: Install the Linux OS onto SD Card</h1><h2 id="5-Setup-microSD-card"><a href="#5-Setup-microSD-card" class="headerlink" title="5. Setup microSD card"></a>5. Setup microSD card</h2><h3 id="1-TF-Card-Preparation"><a href="#1-TF-Card-Preparation" class="headerlink" title="1) TF Card Preparation"></a>1) TF Card Preparation</h3><p>We first check which block device that we are going to install our built system onto by command <strong>lsblk</strong>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ lsblk</span><br><span class="line">NAME    MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sdd       8:48   0 931.5G  0 disk </span><br><span class="line">â””â”€sdd1    8:49   0 931.5G  0 part /media/jiapei/Data</span><br><span class="line">sdb       8:16   0 238.5G  0 disk </span><br><span class="line">â”œâ”€sdb4    8:20   0   900M  0 part </span><br><span class="line">â”œâ”€sdb2    8:18   0   128M  0 part </span><br><span class="line">â”œâ”€sdb3    8:19   0 237.2G  0 part /media/jiapei/Win10</span><br><span class="line">â””â”€sdb1    8:17   0   300M  0 part /boot/efi</span><br><span class="line">sr0      11:0    1  1024M  0 rom  </span><br><span class="line">sdc       8:32   0 238.5G  0 disk </span><br><span class="line">â”œâ”€sdc2    8:34   0  30.5G  0 part [SWAP]</span><br><span class="line">â”œâ”€sdc3    8:35   0 207.5G  0 part /</span><br><span class="line">â””â”€sdc1    8:33   0   512M  0 part </span><br><span class="line">mmcblk0 179:0    0    15G  0 disk</span><br></pre></td></tr></table></figure></p>
<p>We then define a MACRO <strong>DISK</strong> to specify the TF card device.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export DISK=/dev/mmcblk0</span><br></pre></td></tr></table></figure></p>
<p>Afterwards, erase partition table/labels on TF card by:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dd if=/dev/zero of=$&#123;DISK&#125; bs=1M count=10</span><br></pre></td></tr></table></figure></p>
<h3 id="2-Bootloader-installation"><a href="#2-Bootloader-installation" class="headerlink" title="2) Bootloader installation"></a>2) Bootloader installation</h3><p>Now, we install the built U-Boot onto the SD card:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dd if=./u-boot/MLO of=$&#123;DISK&#125; count=1 seek=1 bs=128k</span><br><span class="line">$ sudo dd if=./u-boot/u-boot.img of=$&#123;DISK&#125; count=2 seek=1 bs=384k</span><br></pre></td></tr></table></figure></p>
<h3 id="3-Partition-Preparation"><a href="#3-Partition-Preparation" class="headerlink" title="3) Partition Preparation"></a>3) Partition Preparation</h3><p>We FIRST make sure which version of <strong>sfdisk</strong> is. In my case, it is of version 2.27.1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo sfdisk --version</span><br><span class="line">sfdisk from util-linux 2.27.1</span><br></pre></td></tr></table></figure></p>
<p>Then we create the partition layout by:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo sfdisk $&#123;DISK&#125; &lt;&lt;-__EOF__</span><br><span class="line">4M,,L,*</span><br><span class="line">__EOF__</span><br></pre></td></tr></table></figure></p>
<p>Afterwards, we need to format the created partition by <strong>mkfs.ext4</strong>. We also need to make sure which version of <strong>mkfs.ext4</strong> is. In my case, it is of version 1.42.13.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkfs.ext4 -V</span><br><span class="line">mke2fs 1.42.13 (17-May-2015)</span><br><span class="line">        Using EXT2FS Library version 1.42.13</span><br></pre></td></tr></table></figure></p>
<p>Then, we format the partition by:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkfs.ext4 -L rootfs $&#123;DISK&#125;p1</span><br></pre></td></tr></table></figure></p>
<p>After formatting, the TF card should be able to be either automatically mounted or manually mounted by the following command:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /media/rootfs/</span><br><span class="line">$ sudo mount $&#123;DISK&#125;p1 /media/rootfs/</span><br></pre></td></tr></table></figure></p>
<h3 id="4-Backup-Bootloader"><a href="#4-Backup-Bootloader" class="headerlink" title="4) Backup Bootloader"></a>4) Backup Bootloader</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /media/rootfs/opt/backup/uboot/</span><br><span class="line">$ sudo cp -v ./u-boot/MLO /media/rootfs/opt/backup/uboot/</span><br><span class="line">$ sudo cp -v ./u-boot/u-boot.img /media/rootfs/opt/backup/uboot/</span><br></pre></td></tr></table></figure>
<h3 id="5-Dealing-with-old-Bootloader-in-eMMC-Optional"><a href="#5-Dealing-with-old-Bootloader-in-eMMC-Optional" class="headerlink" title="5) Dealing with old Bootloader in eMMC (Optional)"></a>5) Dealing with old Bootloader in eMMC (Optional)</h3><p>If the old bootloader in eMMC is to be kept, please copy the following file <strong>uEnv.txt</strong> to <strong>/media/rootfs/</strong>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">##This will work with: Angstrom&apos;s 2013.06.20 u-boot.</span><br><span class="line"> </span><br><span class="line">loadaddr=0x82000000</span><br><span class="line">fdtaddr=0x88000000</span><br><span class="line">rdaddr=0x88080000</span><br><span class="line"> </span><br><span class="line">initrd_high=0xffffffff</span><br><span class="line">fdt_high=0xffffffff</span><br><span class="line"> </span><br><span class="line">#for single partitions:</span><br><span class="line">mmcroot=/dev/mmcblk0p1</span><br><span class="line"> </span><br><span class="line">loadximage=load mmc 0:1 $&#123;loadaddr&#125; /boot/vmlinuz-$&#123;uname_r&#125;</span><br><span class="line">loadxfdt=load mmc 0:1 $&#123;fdtaddr&#125; /boot/dtbs/$&#123;uname_r&#125;/$&#123;fdtfile&#125;</span><br><span class="line">loadxrd=load mmc 0:1 $&#123;rdaddr&#125; /boot/initrd.img-$&#123;uname_r&#125;; setenv rdsize $&#123;filesize&#125;</span><br><span class="line">loaduEnvtxt=load mmc 0:1 $&#123;loadaddr&#125; /boot/uEnv.txt ; env import -t $&#123;loadaddr&#125; $&#123;filesize&#125;;</span><br><span class="line">loadall=run loaduEnvtxt; run loadximage; run loadxfdt;</span><br><span class="line"> </span><br><span class="line">mmcargs=setenv bootargs console=tty0 console=$&#123;console&#125; $&#123;optargs&#125; $&#123;cape_disable&#125; $&#123;cape_enable&#125; root=$&#123;mmcroot&#125; rootfstype=$&#123;mmcrootfstype&#125; $&#123;cmdline&#125;</span><br><span class="line"> </span><br><span class="line">uenvcmd=run loadall; run mmcargs; bootz $&#123;loadaddr&#125; - $&#123;fdtaddr&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp -v ./uEnv.txt /media/rootfs/</span><br></pre></td></tr></table></figure>
<h2 id="6-Kernel-Installation"><a href="#6-Kernel-Installation" class="headerlink" title="6. Kernel Installation"></a>6. Kernel Installation</h2><h3 id="1-Export-MACRO-kernel-version"><a href="#1-Export-MACRO-kernel-version" class="headerlink" title="1) Export MACRO kernel_version"></a>1) Export MACRO <strong>kernel_version</strong></h3><p>Under the folder <strong>bb-kernel</strong>, a file named <strong>kernel_version</strong> was generated while building <a href="https://www.kernel.org/" target="_blank" rel="noopener">Linux kernel</a>. In my case, I was building the NEWEST kernel <strong>4.14.13-bone12</strong>. For convenience, we export a new MACRO <strong>kernel_version</strong>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat kernel_version </span><br><span class="line">4.14.13-bone12</span><br><span class="line">$ export kernel_version=4.14.13-bone12</span><br></pre></td></tr></table></figure></p>
<h3 id="2-Extract-Debian-Root-File-System-onto-TF-Card"><a href="#2-Extract-Debian-Root-File-System-onto-TF-Card" class="headerlink" title="2) Extract Debian Root File System onto TF Card"></a>2) Extract Debian Root File System onto TF Card</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tar xfvp ./debian-9.3-minimal-armhf-2017-12-09/armhf-rootfs-debian-stretch.tar -C /media/rootfs/</span><br><span class="line">$ sync</span><br><span class="line">$ sudo chown root:root /media/rootfs/</span><br><span class="line">$ sudo chmod 755 /media/rootfs/</span><br></pre></td></tr></table></figure>
<h3 id="3-Set-uname-r-in-boot-uEnv-txt"><a href="#3-Set-uname-r-in-boot-uEnv-txt" class="headerlink" title="3) Set uname_r in /boot/uEnv.txt"></a>3) Set uname_r in /boot/uEnv.txt</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo sh -c &quot;echo &apos;uname_r=$&#123;kernel_version&#125;&apos; &gt;&gt; /media/rootfs/boot/uEnv.txt&quot;</span><br></pre></td></tr></table></figure>
<h3 id="4-Copy-Kernel-Image"><a href="#4-Copy-Kernel-Image" class="headerlink" title="4) Copy Kernel Image"></a>4) Copy Kernel Image</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp -v ./bb-kernel/deploy/$&#123;kernel_version&#125;.zImage /media/rootfs/boot/vmlinuz-$&#123;kernel_version&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-Copy-Kernel-Device-Tree-Binaries"><a href="#5-Copy-Kernel-Device-Tree-Binaries" class="headerlink" title="5) Copy Kernel Device Tree Binaries"></a>5) Copy Kernel Device Tree Binaries</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /media/rootfs/boot/dtbs/$&#123;kernel_version&#125;/</span><br><span class="line">$ sudo tar xfv ./bb-kernel/deploy/$&#123;kernel_version&#125;-dtbs.tar.gz -C /media/rootfs/boot/dtbs/$&#123;kernel_version&#125;/</span><br></pre></td></tr></table></figure>
<h3 id="6-Copy-Kernel-Modules"><a href="#6-Copy-Kernel-Modules" class="headerlink" title="6) Copy Kernel Modules"></a>6) Copy Kernel Modules</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tar xfv ./bb-kernel/deploy/$&#123;kernel_version&#125;-modules.tar.gz -C /media/rootfs/</span><br></pre></td></tr></table></figure>
<h3 id="7-Set-File-Systems-Table-etc-fstab"><a href="#7-Set-File-Systems-Table-etc-fstab" class="headerlink" title="7) Set File Systems Table (/etc/fstab)"></a>7) Set File Systems Table (/etc/fstab)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo sh -c &quot;echo &apos;/dev/mmcblk0p1  /  auto  errors=remount-ro  0  1&apos; &gt;&gt; /media/rootfs/etc/fstab&quot;</span><br></pre></td></tr></table></figure>
<h3 id="8-Networking"><a href="#8-Networking" class="headerlink" title="8) Networking"></a>8) Networking</h3><p>To enable the Internet for the FIRST booting, we need to do the network configuration:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nano /media/rootfs/etc/network/interfaces</span><br></pre></td></tr></table></figure></p>
<p>Add the following content:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"> </span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet dhcp</span><br></pre></td></tr></table></figure></p>
<p>In order to use a shared SD card with multiple BeagleBones, and always enable the Ethernet interface as <strong>eth0</strong>, we need to add a particular <strong>udev rule</strong> as:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nano /media/rootfs/etc/udev/rules.d/70-persistent-net.rules</span><br></pre></td></tr></table></figure></p>
<p>Add the following content:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># BeagleBone: net device ()</span><br><span class="line">SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR&#123;dev_id&#125;==&quot;0x0&quot;, ATTR&#123;type&#125;==&quot;1&quot;, KERNEL==&quot;eth*&quot;, NAME=&quot;eth0&quot;</span><br></pre></td></tr></table></figure></p>
<h3 id="9-Remove-TF-Card"><a href="#9-Remove-TF-Card" class="headerlink" title="9) Remove TF Card"></a>9) Remove TF Card</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sync</span><br><span class="line">$ sudo umount /media/rootfs</span><br></pre></td></tr></table></figure>
<h1 id="PART-C-Configurations-after-Booting-from-the-SD-Card"><a href="#PART-C-Configurations-after-Booting-from-the-SD-Card" class="headerlink" title="PART C: Configurations after Booting from the SD Card"></a>PART C: Configurations after Booting from the SD Card</h1><p>Insert TF card into a <a href="https://beagleboard.org/black" target="_blank" rel="noopener">Beaglebone Black</a>, connect BBB with an Internet cable, and connect a Micro HDMI cable on demand. After the flashing of on-board LEDs, you should be able to find the IP address of BBB via your router. All our future jobs are to be done via <strong>ssh</strong> command through this IP address. My personal preference is to set a static IP address for this particularly BBB in the router settings.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://longervision.github.io/2018/01/10/beaglebone-black-uboot-kernel/" data-id="cje2bxf7p0000pey7545gyguj" class="article-share-link">Longer Vision</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Beaglebone-Beaglebone-Black-Linaro-GCC-U-Boot-Linux-Kernel-BSP/">Beaglebone, Beaglebone Black, Linaro GCC, U-Boot, Linux Kernel, BSP</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/01/11/orange-pi-plus-2-uboot-kernel-mali/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Build U-Boot, Linux Kernel and Mali Driver for Orange Pi 2 Plus
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Beaglebone-Beaglebone-Black-Linaro-GCC-U-Boot-Linux-Kernel-BSP/">Beaglebone, Beaglebone Black, Linaro GCC, U-Boot, Linux Kernel, BSP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NanoPi-NEO-AllWinner-H3-Armbian-Linaro-GCC-Linum-Mainline-Kernel-BSP/">NanoPi NEO, AllWinner H3, Armbian, Linaro GCC, Linum Mainline Kernel, BSP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Orange-Pi-AllWinner-H3-Linaro-GCC-U-Boot-Linux-Kernel-BSP/">Orange Pi, AllWinner H3, Linaro GCC, U-Boot, Linux Kernel, BSP</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Beaglebone-Beaglebone-Black-Linaro-GCC-U-Boot-Linux-Kernel-BSP/" style="font-size: 10px;">Beaglebone, Beaglebone Black, Linaro GCC, U-Boot, Linux Kernel, BSP</a> <a href="/tags/NanoPi-NEO-AllWinner-H3-Armbian-Linaro-GCC-Linum-Mainline-Kernel-BSP/" style="font-size: 10px;">NanoPi NEO, AllWinner H3, Armbian, Linaro GCC, Linum Mainline Kernel, BSP</a> <a href="/tags/Orange-Pi-AllWinner-H3-Linaro-GCC-U-Boot-Linux-Kernel-BSP/" style="font-size: 10px;">Orange Pi, AllWinner H3, Linaro GCC, U-Boot, Linux Kernel, BSP</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/02/24/nanopi-neo-armbian/">Install Armbian with the Newest Mainline Kernel onto NanoPi NEO</a>
          </li>
        
          <li>
            <a href="/2018/01/11/orange-pi-plus-2-uboot-kernel-mali/">Build U-Boot, Linux Kernel and Mali Driver for Orange Pi 2 Plus</a>
          </li>
        
          <li>
            <a href="/2018/01/10/beaglebone-black-uboot-kernel/">Build U-Boot and Linux Kernel for Beaglebone and Beaglebone Black</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Longer Vision<br>
      Powered by <a href="http://www.longervision.com/" target="_blank">Longer Vision</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>