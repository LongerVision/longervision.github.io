<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Camera Posture Estimation Using A Single aruco Marker | Longer Vision</title>
  <meta name="author" content="Nobody">
  
  <meta name="description" content="PreparationBefore start coding, you need to make sure that the camera to be used has already been calibrated. (Camera calibration is covered in our bl">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Camera Posture Estimation Using A Single aruco Marker"/>
  <meta property="og:site_name" content="Longer Vision"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Longer Vision" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Longer Vision</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-03-11T00:38:47.000Z"><a href="/2017/03/10/opencv-calibration/">2017-03-10</a></time>
      
      
  
    <h1 class="title">Camera Posture Estimation Using A Single aruco Marker</h1>
  

    </header>
    <div class="entry">
      
        <p></p><h2>Preparation</h2><br>Before start coding, you need to make sure that the camera to be used has already been calibrated. (Camera calibration is covered in our blog, and some pieces of codes are provided as well.) In the following coding, itâ€™s assumed that you can successfully load the camera calibration parameters.<p></p>
<p></p><h2>Coding</h2><p></p>
<p></p><h3>First of all</h3><br>We need to ensure cv2.so is included under our system folder. <strong>cv2.so</strong> is specifically for OpenCV Python.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">import sys</div><div class="line">sys.path.append(&apos;/usr/local/python/3.5&apos;)</div></pre></td></tr></table></figure><p></p>
<p>Then, some standard packages need to be imported. (Due to your own requirements)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import os</div><div class="line">import cv2</div><div class="line">from cv2 import aruco</div><div class="line">import numpy as np</div></pre></td></tr></table></figure></p>
<p></p><h3>Secondly</h3><br>We now load all camera calibration parameters, including: <strong>cameraMatrix</strong>, <strong>distCoeffs</strong>, etc. For example, your code might look like the following:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">calibrationFile = &quot;calibrationFileName.xml&quot;</div><div class="line">calibrationParams = cv2.FileStorage(calibrationFile, cv2.FILE_STORAGE_READ)</div><div class="line">camera_matrix = calibrationParams.getNode(&quot;cameraMatrix&quot;).mat()</div><div class="line">dist_coeffs = calibrationParams.getNode(&quot;distCoeffs&quot;).mat()</div></pre></td></tr></table></figure><p></p>
<p>Since we are testing a calibrated fisheye camera, two extra parameters are to be loaded from the calibration file.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">r = calibrationParams.getNode(&quot;R&quot;).mat()</div><div class="line">new_camera_matrix = calibrationParams.getNode(&quot;newCameraMatrix&quot;).mat()</div></pre></td></tr></table></figure></p>
<p>Afterwards, two mapping matrices are calculated by calling function <strong>cv2.fisheye.initUndistortRectifyMap()</strong> as (supposing the images to be processed are of 1080P):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">image_size = (1920, 1080)</div><div class="line">map1, map2 = cv2.fisheye.initUndistortRectifyMap(camera_matrix, dist_coeffs, r, new_camera_matrix, image_size, cv2.CV_16SC2)</div></pre></td></tr></table></figure></p>
<p></p><h3>Thirdly</h3><br>We load a dictionary to be used. Current OpenCV provides four groups of <a href="http://docs.opencv.org/trunk/d9/d6a/group__aruco.html" target="_blank" rel="external">aruco</a> patterns, <strong>4X4</strong>, <strong>5X5</strong>, <strong>6X6</strong>, <strong>7X7</strong>, etc. Here, <strong>aruco.DICT_6X6_1000</strong> is arbitrarily selected as an example, which looks like:<br><img src="https://raw.githubusercontent.com/jiapei100/OpenCV_Examples/master/markers/marker_66.jpg" alt="aruco.DICT_6X6_1000" title="aruco.DICT_6X6_1000"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">aruco_dict = aruco.Dictionary_get( aruco.DICT_6X6_1000 )</div></pre></td></tr></table></figure><p></p>
<p>Meanwhile, create aruco detector with default parameters.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">arucoParams = aruco.DetectorParameters_create()</div></pre></td></tr></table></figure></p>
<p></p><h3>Finally</h3><br>Estimate camera postures. Here, we are testing a sequence of images, instead of video streams. We first list all file names in sequence.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">imgDir = &quot;imgSequence&quot;  # Specify the image directory</div><div class="line">imgFileNames = [os.path.join(imgDir, fn) for fn in next(os.walk(imgDir))[2]]</div><div class="line">nbOfImgs = len(imgFileNames)</div></pre></td></tr></table></figure><p></p>
<p>Then, we calculate the camera posture frame by frame:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">for i in range(0, nbOfImgs):</div><div class="line">  img = cv2.imread(imgFileNames[i], cv2.IMREAD_GRAYSCALE)</div><div class="line">  imgRemapped = cv2.remap(img, map1, map2, cv2.INTER_LINEAR, cv2.BORDER_CONSTANT) # for fisheye</div><div class="line">  imRemapped_color = cv2.cvtColor(imgRemapped, cv2.COLOR_GRAY2BGR)  # for later display in color</div><div class="line"></div><div class="line">  corners, ids, rejectedImgPoints = aruco.detectMarkers(imgRemapped, aruco_dict, parameters=arucoParams) # Detect aruco</div><div class="line">  if ids != None:</div><div class="line">    # For a single marker</div><div class="line">    rvec, tvec = aruco.estimatePoseSingleMarkers(corners, 20, camera_matrix, dist_coeffs)</div><div class="line">    imgWithAruco = aruco.drawDetectedMarkers(imRemapped_color, corners, None, (0,255,0))</div><div class="line">    imgWithAruco = aruco.drawAxis(imgWithAruco, camera_matrix, dist_coeffs, rvec, tvec, 100)</div><div class="line">  else:</div><div class="line">    imgWithAruco = imRemapped_color</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/Camera-Posture-Estimation-aruco-Marker-Pattern-OpenCV-Python/">Camera Posture Estimation, aruco, Marker, Pattern, OpenCV, Python</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Kommentare</h1>

  
      <div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=123456789012345";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

<div class="fb-comments" data-href="http://longervision.github.io/2017/03/10/opencv-calibration/index.html" data-num-posts="5" data-width="840" data-colorscheme="light"></div>
      
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Suche">
    <input type="hidden" name="q" value="site:longervision.github.io">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/Camera-Posture-Estimation-aruco-Marker-Pattern-OpenCV-Python/">Camera Posture Estimation, aruco, Marker, Pattern, OpenCV, Python</a><small>1</small></li>
  
    <li><a href="/tags/Longer-Vision-Technology-Computer-Vision-Machine-Vision/">Longer Vision Technology, Computer Vision, Machine Vision</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 Nobody
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
